<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Scorecard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f5f5f5;
            width: 100%;
            min-height: 100vh;
            padding: 15px;
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 24px;
        }

        .game-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .selector-group {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .selector-group label {
            font-weight: bold;
            color: #333;
        }

        .selector-group select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            min-width: 150px;
        }

        .btn {
            padding: 10px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scorecard {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .scorecard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
        }

        .score-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
        }

        .score-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .score-table .category-cell {
            background: #ff7043;
            color: white;
            font-weight: bold;
            text-align: left;
            padding-left: 15px;
        }

        .score-table .total-row {
            background: #ffecb3;
            font-weight: bold;
        }

        .score-table .rank-row {
            background: #b0bec5;
            font-weight: bold;
        }

        .score-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 14px;
        }

        .score-table input:focus {
            outline: none;
            border-color: #667eea;
        }

        .score-table .player-header {
            background: #5c6bc0;
        }

        .message {
            text-align: center;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
            font-weight: bold;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .save-section {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .score-table {
                font-size: 12px;
            }
            
            .score-table th,
            .score-table td {
                padding: 6px 4px;
            }
            
            .score-table input {
                padding: 6px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 Game Scorecard</h1>
        
        <div id="message" class="message"></div>
        
        <!-- Game Selector -->
        <div class="game-selector">
            <div class="selector-group">
                <label for="gameSelect">Select Your Game:</label>
                <select id="gameSelect">
                    <option value="">-- Choose Game --</option>
                </select>
                <button class="btn" onclick="loadScorecard()">Load Scorecard</button>
            </div>
        </div>

        <!-- Scorecard Section -->
        <div id="scorecardSection" class="hidden">
            <div class="scorecard">
                <div class="scorecard-header" id="scorecardTitle">GAME 1 - FINAL SCORE</div>
                
                <table class="score-table" id="scoreTable">
                    <thead>
                        <tr>
                            <th>Table 1</th>
                            <th class="player-header">Player #1</th>
                            <th class="player-header">Player #2</th>
                            <th class="player-header">Player #3</th>
                            <th class="player-header">Player #4</th>
                        </tr>
                    </thead>
                    <tbody id="scoreTableBody">
                        <tr>
                            <td class="category-cell">Player Name</td>
                            <td><input type="text" id="player1Name" placeholder="Name"></td>
                            <td><input type="text" id="player2Name" placeholder="Name"></td>
                            <td><input type="text" id="player3Name" placeholder="Name"></td>
                            <td><input type="text" id="player4Name" placeholder="Name"></td>
                        </tr>
                        <tr>
                            <td class="category-cell">Corporation</td>
                            <td><input type="number" class="score-input" data-player="1" data-category="corporation" value="0"></td>
                            <td><input type="number" class="score-input" data-player="2" data-category="corporation" value="0"></td>
                            <td><input type="number" class="score-input" data-player="3" data-category="corporation" value="0"></td>
                            <td><input type="number" class="score-input" data-player="4" data-category="corporation" value="0"></td>
                        </tr>
                        <tr>
                            <td class="category-cell">TR</td>
                            <td><input type="number" class="score-input" data-player="1" data-category="tr" value="0"></td>
                            <td><input type="number" class="score-input" data-player="2" data-category="tr" value="0"></td>
                            <td><input type="number" class="score-input" data-player="3" data-category="tr" value="0"></td>
                            <td><input type="number" class="score-input" data-player="4" data-category="tr" value="0"></td>
                        </tr>
                        <tr>
                            <td class="category-cell">Récompenses</td>
                            <td><input type="number" class="score-input" data-player="1" data-category="rewards" value="0"></td>
                            <td><input type="number" class="score-input" data-player="2" data-category="rewards" value="0"></td>
                            <td><input type="number" class="score-input" data-player="3" data-category="rewards" value="0"></td>
                            <td><input type="number" class="score-input" data-player="4" data-category="rewards" value="0"></td>
                        </tr>
                        <tr>
                            <td class="category-cell">Objectifs</td>
                            <td><input type="number" class="score-input" data-player="1" data-category="objectives" value="0"></td>
                            <td><input type="number" class="score-input" data-player="2" data-category="objectives" value="0"></td>
                            <td><input type="number" class="score-input" data-player="3" data-category="objectives" value="0"></td>
                            <td><input type="number" class="score-input" data-player="4" data-category="objectives" value="0"></td>
                        </tr>
                        <tr>
                            <td class="category-cell">Forêts</td>
                            <td><input type="number" class="score-input" data-player="1" data-category="forests" value="0"></td>
                            <td><input type="number" class="score-input" data-player="2" data-category="forests" value="0"></td>
                            <td><input type="number" class="score-input" data-player="3" data-category="forests" value="0"></td>
                            <td><input type="number" class="score-input" data-player="4" data-category="forests" value="0"></td>
                        </tr>
                        <tr>
                            <td class="category-cell">Villes</td>
                            <td><input type="number" class="score-input" data-player="1" data-category="cities" value="0"></td>
                            <td><input type="number" class="score-input" data-player="2" data-category="cities" value="0"></td>
                            <td><input type="number" class="score-input" data-player="3" data-category="cities" value="0"></td>
                            <td><input type="number" class="score-input" data-player="4" data-category="cities" value="0"></td>
                        </tr>
                        <tr>
                            <td class="category-cell">Cartes</td>
                            <td><input type="number" class="score-input" data-player="1" data-category="cards" value="0"></td>
                            <td><input type="number" class="score-input" data-player="2" data-category="cards" value="0"></td>
                            <td><input type="number" class="score-input" data-player="3" data-category="cards" value="0"></td>
                            <td><input type="number" class="score-input" data-player="4" data-category="cards" value="0"></td>
                        </tr>
                        <tr class="total-row">
                            <td class="category-cell">Total</td>
                            <td id="total1">0</td>
                            <td id="total2">0</td>
                            <td id="total3">0</td>
                            <td id="total4">0</td>
                        </tr>
                        <tr class="rank-row">
                            <td class="category-cell">Classement</td>
                            <td id="rank1">-</td>
                            <td id="rank2">-</td>
                            <td id="rank3">-</td>
                            <td id="rank4">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="save-section">
                <button class="btn" onclick="saveScorecard()">💾 Save Scores</button>
            </div>
        </div>
    </div>

    <script>
        // Shared database configuration
        const DB_API_URL = 'https://api.jsonbin.io/v3/b/68f777cb43b1c97be975bb7e';
        const DB_API_KEY = '$2a$10$nrEAvkxKI94V3ZAk5YxiQezRgOGew.SEYJUZGHDog17c2dhPqacrq';
        const USE_LOCAL_STORAGE = false;

        let allPlayers = [];
        let games = [];
        let currentGameId = null;
        let scorecards = [];

        // Show message to user
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 4000);
        }

        // Load data from database
        async function loadData() {
            try {
                if (USE_LOCAL_STORAGE) {
                    allPlayers = JSON.parse(localStorage.getItem('sharedPlayers') || '[]');
                    scorecards = JSON.parse(localStorage.getItem('scorecards') || '[]');
                } else {
                    const response = await fetch(DB_API_URL, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': DB_API_KEY
                        }
                    });
                    const data = await response.json();
                    allPlayers = data.record.players || [];
                    scorecards = data.record.scorecards || [];
                }

                // Extract unique games from players
                games = [];
                const gameIds = new Set();
                allPlayers.forEach(player => {
                    if (player.gameId && !gameIds.has(player.gameId)) {
                        gameIds.add(player.gameId);
                        const gamePlayers = allPlayers.filter(p => p.gameId === player.gameId);
                        games.push({
                            id: player.gameId,
                            name: `Game ${games.length + 1}`,
                            players: gamePlayers
                        });
                    }
                });

                populateGameSelector();
            } catch (error) {
                showMessage('❌ Error loading data: ' + error.message, 'error');
            }
        }

        // Populate game selector dropdown
        function populateGameSelector() {
            const select = document.getElementById('gameSelect');
            select.innerHTML = '<option value="">-- Choose Game --</option>';
            
            games.forEach((game, index) => {
                const option = document.createElement('option');
                option.value = game.id;
                option.textContent = `${game.name} (${game.players.length} players)`;
                select.appendChild(option);
            });
        }

        // Load scorecard for selected game
        function loadScorecard() {
            const gameId = parseInt(document.getElementById('gameSelect').value);
            if (!gameId) {
                showMessage('❌ Please select a game', 'error');
                return;
            }

            currentGameId = gameId;
            const game = games.find(g => g.id === gameId);
            
            if (!game) {
                showMessage('❌ Game not found', 'error');
                return;
            }

            // Update title
            document.getElementById('scorecardTitle').textContent = `${game.name.toUpperCase()} - FINAL SCORE`;
            
            // Load existing scorecard if available
            const existingScorecard = scorecards.find(s => s.gameId === gameId);
            
            if (existingScorecard) {
                // Populate with existing data
                for (let i = 1; i <= 4; i++) {
                    const playerData = existingScorecard.players[i - 1];
                    if (playerData) {
                        document.getElementById(`player${i}Name`).value = playerData.name || '';
                        Object.keys(playerData.scores).forEach(category => {
                            const input = document.querySelector(`input[data-player="${i}"][data-category="${category}"]`);
                            if (input) input.value = playerData.scores[category];
                        });
                    }
                }
            } else {
                // Populate with game players
                game.players.forEach((player, index) => {
                    if (index < 4) {
                        document.getElementById(`player${index + 1}Name`).value = player.name;
                    }
                });
            }

            // Show scorecard section
            document.getElementById('scorecardSection').classList.remove('hidden');
            
            // Add event listeners for auto-calculation
            document.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('input', calculateTotals);
            });
            
            calculateTotals();
            showMessage('✅ Scorecard loaded', 'success');
        }

        // Calculate totals and rankings
        function calculateTotals() {
            const totals = [];
            
            for (let i = 1; i <= 4; i++) {
                let total = 0;
                document.querySelectorAll(`input[data-player="${i}"].score-input`).forEach(input => {
                    total += parseInt(input.value) || 0;
                });
                document.getElementById(`total${i}`).textContent = total;
                totals.push({ player: i, total });
            }

            // Calculate rankings
            totals.sort((a, b) => b.total - a.total);
            const rankings = {};
            let currentRank = 1;
            let previousTotal = -1;
            
            totals.forEach((item, index) => {
                if (item.total !== previousTotal) {
                    currentRank = index + 1;
                }
                rankings[item.player] = currentRank;
                previousTotal = item.total;
            });

            // Update rankings display
            for (let i = 1; i <= 4; i++) {
                const rank = rankings[i];
                let rankText = rank;
                if (rank === 1) rankText = '🥇 1st';
                else if (rank === 2) rankText = '🥈 2nd';
                else if (rank === 3) rankText = '🥉 3rd';
                else rankText = `${rank}th`;
                
                document.getElementById(`rank${i}`).textContent = rankText;
            }
        }

        // Save scorecard to database
        async function saveScorecard() {
            if (!currentGameId) {
                showMessage('❌ No game selected', 'error');
                return;
            }

            const scorecardData = {
                gameId: currentGameId,
                savedAt: new Date().toISOString(),
                players: []
            };

            // Collect all player data
            for (let i = 1; i <= 4; i++) {
                const playerName = document.getElementById(`player${i}Name`).value;
                const scores = {};
                
                document.querySelectorAll(`input[data-player="${i}"].score-input`).forEach(input => {
                    scores[input.dataset.category] = parseInt(input.value) || 0;
                });

                const total = parseInt(document.getElementById(`total${i}`).textContent);
                const rank = document.getElementById(`rank${i}`).textContent;

                scorecardData.players.push({
                    name: playerName,
                    scores,
                    total,
                    rank
                });
            }

            // Update or add scorecard
            const existingIndex = scorecards.findIndex(s => s.gameId === currentGameId);
            if (existingIndex >= 0) {
                scorecards[existingIndex] = scorecardData;
            } else {
                scorecards.push(scorecardData);
            }

            // Save to database
            try {
                if (USE_LOCAL_STORAGE) {
                    localStorage.setItem('scorecards', JSON.stringify(scorecards));
                } else {
                    await fetch(DB_API_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': DB_API_KEY
                        },
                        body: JSON.stringify({ 
                            players: allPlayers,
                            scorecards: scorecards
                        })
                    });
                }
                showMessage('✅ Scorecard saved successfully!', 'success');
            } catch (error) {
                showMessage('❌ Error saving: ' + error.message, 'error');
            }
        }

        // Initialize on page load
        loadData();
    </script>
</body>
</html>
